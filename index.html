<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Food Webmap</title>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #sliderDiv {
            width: 300px;
            height: 70px;
        }
        calcite-chip-group, calcite-label {
            box-shadow: none !important;
        }
        calcite-chip, calcite-checkbox {
            box-shadow: 0 0 1px black !important;
        }
        calcite-label {
            text-shadow: 0px 0px 5px #797979;
        }
        
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <script type="module" src=https://js.arcgis.com/calcite-components/2.1.0/calcite.esm.js></script>
    <link rel="stylesheet" type="text/css" href=https://js.arcgis.com/calcite-components/2.1.0/calcite.css />
    <script src="https://tumde-my.sharepoint.com/personal/itay_swid_tum_de/_layouts/15/download.aspx?SourceUrl=%2Fpersonal%2Fitay%5Fswid%5Ftum%5Fde%2FDocuments%2FMapping%20Project%2FWebappScript%2Ejs"></script>

    <script>
        require([
            "esri/config",
            "esri/Map",
            "esri/widgets/Locate",
            "esri/WebMap",
            "esri/widgets/Slider",
            "esri/views/MapView",
            "esri/widgets/Home"
        ], function (esriConfig, Map, Locate, WebMap, Slider, MapView, Home) {
            esriConfig.apiKey = "AAPKea7d371c6ad74cf98f0258f9669bcf9aL_uNXpDBiLtRKWKl0psU94aKUqzozzbL_saCnKrfrMZM4nJHgToZXliqrMEsyoSf";
            const webmap = new WebMap({
                portalItem: {
                    id: "5c479132a5c4419bad5e5fb4ca92f40a"
                }
            });
            const view = new MapView({
                container: "viewDiv",
                map: webmap
            });
            //
            view.ui.move(["zoom"], "top-right");
            view.ui.add(new Home({view:view}), "top-right");
            //
            //
            // Locator configuration
            const locate = new Locate({
                view: view,
                rotationEnabled: false,
                goToOverride: function (view, options) {
                    options.target.scale = 1500;
                    return view.goTo(options.target);
                }
            });
            //
            view.ui.add(locate, "top-right");
            //
            //
            // Diet choice configuration
            const chipGroup = document.createElement('calcite-chip-group');
            chipGroup.setAttribute('label', 'Diet filtering');
            chipGroup.setAttribute('selection-mode', 'multiple');
            // Gluten free diet choice
            const gluChip = document.createElement('calcite-chip');
            gluChip.setAttribute('value', `${diet} LIKE '%gluten%'`);
            gluChip.appendChild(createGlutSVGElement());
            gluChip.appendChild(document.createTextNode('Gluten free'));
            chipGroup.appendChild(gluChip);
            // Vegeterian diet choice
            const vegChip = document.createElement('calcite-chip');
            vegChip.setAttribute('value', `${diet} LIKE '%vegetarian%'`);
            vegChip.appendChild(createVegeSVGElement());
            vegChip.appendChild(document.createTextNode('Vegeterian'));
            chipGroup.appendChild(vegChip);
            // Vegan diet choice
            const vanChip = document.createElement('calcite-chip');
            vanChip.setAttribute('value', `${diet} LIKE '%vegan%'`);
            vanChip.appendChild(createVegaSVGElement());
            vanChip.appendChild(document.createTextNode('Vegan'));
            chipGroup.appendChild(vanChip);
            //
            view.ui.add(chipGroup, "top-left");
            //
            // Vegan and Vegetarian self-cencellation behaviour
            // For some reason, selected flag is reversed. May be a bug.
            vanChip.addEventListener('calciteChipSelect', function (event) {
                if (!event.target.selected) vegChip.setAttribute('selected', false);
            });
            vegChip.addEventListener('calciteChipSelect', function (event) {
                if (!event.target.selected) vanChip.setAttribute('selected', false);
            });
            //
            //
            // Combobox configuration
            const calcComb = document.createElement("calcite-combobox");
            calcComb.setAttribute("placeholder", "Dishes or Cuisines");
            const cusnGroup = document.createElement("calcite-combobox-item-group");
            cusnGroup.setAttribute("label", cusns);
            const dishGroup = document.createElement("calcite-combobox-item-group");
            dishGroup.setAttribute("label", dishs);
            calcComb.appendChild(cusnGroup);
            calcComb.appendChild(dishGroup);
            //
            view.ui.add(calcComb, "top-left");
            //
            //
            // Checkbox for time filtering
            const timeFltr = document.createElement("calcite-checkbox")
            timeLabl = document.createElement("calcite-label")
            timeLabl.appendChild(timeFltr)
            timeLabl.appendChild(document.createTextNode('Enable time filters'))
            timeLabl.setAttribute('layout', "inline")
            view.ui.add(timeLabl, "top-left");
            //
            //
            // Day picker configuration
            const segmDays = document.createElement('calcite-segmented-control');
            segmDays.layout = 'vertical'
            segmDays.disabled = !timeFltr.checked
            days.forEach(day => {
                let segItem = document.createElement('calcite-segmented-control-item');
                segItem.setAttribute('value', day);
                segItem.textContent = day.substring(0, 3);
                if (day == days[now.getDay()]) segItem.setAttribute('checked', true);
                segmDays.appendChild(segItem);
            })
            view.ui.add(segmDays, 'bottom-left')
            //
            //
            // Time slider configuration
            const col = '#4287f5';
            const slider = new Slider({
                container: "sliderDiv",
                min: 0,
                max: 24,
                values: [now.getHours(),
                Math.min(now.getHours() + 5, 24)
                ],
                steps: [...Array(49).keys()].map(function (item) {
                    return item / 2
                }),
                labelFormatFunction: function (value) {
                    return `${parseInt(value)}:` + `${60 * (value - parseInt(value))}`.padStart(2, '0')
                },
                visibleElements: {
                    labels: true,
                    rangeLabels: true
                },
                disabled: !timeFltr.checked
            });
            const sg = slider.segmentElements

            function setSegmentColor(seg, color) {
                seg.style['background-color'] = color;
            }
            sg.on('after-add', function (event) {
                if (sg.length == 2) setSegmentColor(event.item, col);
            })
            slider.on('thumb-drag', function () {
                setSegmentColor(sg.at(1), col)
            });
            slider.on('segment-drag', function () {
                setSegmentColor(sg.at(1), col)
            });
            view.ui.add(document.getElementById("sliderDiv"), "bottom-left");
            //
            //
            // Runs after webmap is loaded
            view.when(function () {
                // Here we can use the layers
                //
                // Get the relevant layers to filter
                const restLayers = view.map.allLayers.filter(function (layer) {
                    return layer.type !== 'group' && layer.title.includes(rest);
                });
                //
                // Saving the first layer to quary data from
                const restLyr = restLayers.getItemAt(0);
                //
                //
                // Runs after layer is loaded
                restLyr.when(async function () {
                    // Here we can use data from the layer
                    //
                    // Build query to get all cuisines in the data
                    var cusnQ = restLyr.createQuery();
                    cusnQ.returnDistinctValues = true;
                    cusnQ.outFields = [cusn];
                    cusnQ.returnGeometry = false;
                    //
                    // Use them to build HTML element to host the corresponding SQL filter
                    (await restLyr.queryFeatures(cusnQ)).features.forEach(function (feature) {
                        let cCusn = feature.attributes[cusn];
                        addNewComboboxOption(cusnGroup, cCusn, `${cusn} = '${cCusn}'`);
                    });
                    //
                    //
                    // Build quary to get all data
                    var dataQ = restLyr.createQuery();
                    dataQ.outFields = ['OBJECTID', dish].concat(days);
                    dataQ.returnGeometry = false;
                    const data = (await restLyr.queryFeatures(dataQ)).features
                    //
                    // Adding option to display features with null dishes
                    addNewComboboxOption(dishGroup, "No dish data", `${dish} IS NULL`)
                    //
                    // Creating a list of unique dishes, and use it to
                    // build HTML element to host the corrisponding SQL filter
                    dishDataToListOfUniqueValues(data).forEach(function (cRest) {
                        addNewComboboxOption(dishGroup, firstUpper(cRest), `${dish} LIKE '%${cRest}%'`);
                    });

                    function updateQuery() {
                        restLayers.forEach(function (layer) {
                            layer.definitionExpression = buildCompleteSQLQuery(calcComb.selectedItems,
                                chipGroup.selectedItems, timeFltr.checked, segmDays.value, slider.values, data);
                        });
                        console.log('Current SQL Query:\n' + restLayers.at(0).definitionExpression);
                    }
                    //
                    //
                    // Event listener for Chip Group
                    chipGroup.addEventListener('calciteChipGroupSelect', updateQuery);
                    //
                    //
                    // Event listener for Combobox
                    calcComb.addEventListener('calciteComboboxChange', updateQuery);
                    //
                    //
                    // Event listener for the slider and day picker
                    slider.on('thumb-drag', updateQuery);
                    slider.on('segment-drag', updateQuery);
                    segmDays.addEventListener('calciteSegmentedControlChange', updateQuery);
                    //
                    //
                    // Event listener for time filter activation
                    timeFltr.addEventListener('calciteCheckboxChange', updateQuery)
                    timeFltr.addEventListener('calciteCheckboxChange', function (event) {
                        slider.disabled = !event.target.checked;
                        segmDays.disabled = !event.target.checked;
                    })
                    //
                    //
                    updateQuery();
                }); // End layer when
            }); // End webmap when
        }); // End require
    </script>
</head>

<body>
    <div id="viewDiv"></div>
    <div id="sliderDiv"></div>
</body>

</html>